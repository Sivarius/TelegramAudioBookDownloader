<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TeleGaParser UI</title>
  <style>
    :root {
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #1f2933;
      --muted: #6b7c93;
      --line: #d9e2ec;
      --primary: #0b6efd;
      --ok: #0f9d58;
      --warn: #d97706;
      --row: #f7fafc;
      --status-bg: #f8fbff;
      --input-bg: #ffffff;
      --btn-secondary: #4a5a70;
    }
    [data-theme="dark"] {
      --bg: #0f1720;
      --card: #17212b;
      --text: #e5edf6;
      --muted: #9fb0c4;
      --line: #324355;
      --primary: #3b82f6;
      --ok: #22c55e;
      --warn: #f59e0b;
      --row: #1e2b38;
      --status-bg: #1b2734;
      --input-bg: #1e2b38;
      --btn-secondary: #2f3e4e;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg) 100%);
      color: var(--text);
    }
    .wrap {
      max-width: 1260px;
      margin: 24px auto;
      padding: 0 16px;
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 14px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 6px 20px rgba(16, 24, 40, 0.06);
    }
    h1 {
      margin: 0 0 6px;
      font-size: 24px;
    }
    h2 {
      margin: 0 0 10px;
      font-size: 18px;
    }
    .sub {
      margin: 0 0 16px;
      color: var(--muted);
      font-size: 14px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .full {
      grid-column: 1 / -1;
    }
    label {
      font-size: 13px;
      color: var(--muted);
      display: block;
      margin-bottom: 5px;
    }
    .label-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 5px;
      flex-wrap: wrap;
    }
    .label-row label {
      margin-bottom: 0;
    }
    .inline-link {
      font-size: 12px;
      color: var(--primary);
      text-decoration: none;
    }
    .inline-link:hover {
      text-decoration: underline;
    }
    .help {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid var(--line);
      color: var(--muted);
      font-size: 11px;
      cursor: help;
      user-select: none;
    }
    .help::after {
      content: attr(data-tip);
      position: absolute;
      left: 50%;
      bottom: calc(100% + 8px);
      transform: translateX(-50%);
      min-width: 180px;
      max-width: 260px;
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px 9px;
      font-size: 12px;
      line-height: 1.3;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      display: none;
      z-index: 10;
      pointer-events: none;
    }
    .help:hover::after,
    .help:focus::after {
      display: block;
    }
    input,
    select {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 10px 12px;
      box-sizing: border-box;
      font-size: 14px;
      color: var(--text);
      background: var(--input-bg);
    }
    .field-sm input {
      max-width: 210px;
    }
    .field-xs input {
      max-width: 150px;
    }
    .index-inline {
      display: grid;
      grid-template-columns: minmax(260px, 320px) repeat(2, minmax(120px, 150px));
      gap: 12px;
      align-items: end;
    }
    .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .tab-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .tab-btn.active {
      background: var(--primary);
      color: #fff;
    }
    .tab-panel {
      display: none;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: var(--status-bg);
      margin-bottom: 10px;
    }
    .tab-panel.active {
      display: block;
    }
    .menu-box {
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: var(--status-bg);
    }
    .menu-box.hidden {
      display: none;
    }
    .debug-box {
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: var(--status-bg);
      padding: 10px;
      max-height: 240px;
      overflow: auto;
      display: none;
    }
    .debug-box.show {
      display: block;
    }
    .debug-log {
      margin: 0;
      white-space: pre-wrap;
      font-family: Consolas, monospace;
      font-size: 12px;
      color: var(--text);
    }
    .channel-item {
      display: grid;
      grid-template-columns: 1.2fr 1fr auto;
      align-items: start;
      gap: 10px;
      border-bottom: 1px solid var(--line);
      padding: 8px 0;
    }
    .channel-item:last-child {
      border-bottom: 0;
    }
    .badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
    }
    .badge.ok {
      color: var(--ok);
      border-color: var(--ok);
    }
    .badge.warn {
      color: var(--warn);
      border-color: var(--warn);
    }
    .channel-meta .mono {
      line-height: 1.2;
      word-break: break-all;
    }
    .channel-prefs {
      display: grid;
      gap: 4px;
      margin-top: 2px;
    }
    .channel-prefs .check-row {
      margin: 0;
      gap: 6px;
      font-size: 13px;
    }
    .channel-prefs input[type="checkbox"] {
      transform: scale(0.95);
    }
    .channel-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      min-width: 96px;
    }
    .check-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      margin-bottom: 6px;
    }
    .check-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(220px, 1fr));
      gap: 6px 16px;
      align-items: center;
    }
    .check-grid .check-row {
      margin: 0;
    }
    .check-row input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    .hidden {
      display: none;
    }
    .btn {
      border: 0;
      border-radius: 8px;
      padding: 11px 14px;
      font-size: 14px;
      cursor: pointer;
      background: var(--primary);
      color: #fff;
    }
    .btn.secondary {
      background: var(--btn-secondary);
    }
    .btn.compact {
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 7px;
    }
    .btn.xs {
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 7px;
    }
    .status {
      margin-top: 14px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: var(--status-bg);
      font-size: 14px;
    }
    .run {
      color: var(--ok);
      font-weight: 600;
    }
    .stop {
      color: var(--warn);
      font-weight: 600;
    }
    .table-wrap {
      max-height: 70vh;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid var(--line);
      text-align: left;
      vertical-align: top;
    }
    th {
      position: sticky;
      top: 0;
      background: var(--row);
      z-index: 1;
    }
    .mono {
      font-family: Consolas, monospace;
    }
    .progress-cell progress {
      width: 100%;
      height: 9px;
    }
    .progress-meta {
      margin-top: 2px;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.2;
    }
    .note {
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
    }
    .downloaded-ok {
      color: var(--ok);
      font-weight: 700;
      font-size: 16px;
      line-height: 1;
    }
    .downloaded-empty {
      color: var(--muted);
    }
    @media (max-width: 980px) {
      .wrap {
        grid-template-columns: 1fr;
      }
      .channel-item {
        grid-template-columns: 1fr;
      }
      .channel-actions {
        align-items: flex-start;
      }
    }
    @media (max-width: 720px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .check-grid {
        grid-template-columns: 1fr;
      }
      .field-sm input {
        max-width: 100%;
      }
      .field-xs input {
        max-width: 100%;
      }
      .index-inline {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>TeleGaParser</h1>
      <p class="sub">Авторизация Telegram, выбор канала и запуск скачивания аудио.</p>
      <div class="btn-row">
        <button id="theme-toggle" class="btn secondary compact" type="button">Тёмная тема</button>
        <button id="channel-menu-toggle" class="btn secondary compact" type="button">История каналов</button>
        <label class="check-row" style="margin:0 0 0 4px;">
          <input id="debug-toggle" type="checkbox">
          <span>Дебаг</span>
        </label>
      </div>
      <div id="channel-menu-box" class="menu-box hidden">
        <div id="channel-menu-status" class="sub">Загрузка списка каналов...</div>
        <div id="channel-menu-list"></div>
      </div>

      <form method="post" action="/authorize">
        <div class="tab-row">
          <button type="button" class="btn secondary compact tab-btn active" data-tab-target="tab-control">Пульт</button>
          <button type="button" class="btn secondary compact tab-btn" data-tab-target="tab-telegram">Telegram</button>
          <button type="button" class="btn secondary compact tab-btn" data-tab-target="tab-sftp">SFTP</button>
          <button type="button" class="btn secondary compact tab-btn" data-tab-target="tab-ftps">FTPS</button>
        </div>

        <div id="tab-control" class="tab-panel active">
          <div class="grid">
            <div class="field-sm">
              <div class="label-row">
                <label>STARTUP_SCAN_LIMIT</label>
                <span class="help" tabindex="0" data-tip="Сколько последних сообщений проверить при старте.">?</span>
              </div>
              <input name="startup_scan_limit" value="{{ form.startup_scan_limit }}">
            </div>
            <div class="field-sm">
              <div class="label-row">
                <label>Потоков загрузки</label>
                <span class="help" tabindex="0" data-tip="Сколько аудиофайлов скачивать одновременно. Рекомендуется 2-4.">?</span>
              </div>
              <input name="download_concurrency" value="{{ form.download_concurrency }}" placeholder="3">
            </div>
            <div class="full check-grid">
              <label class="check-row"><input id="remember_me" type="checkbox" name="remember_me" {% if form.remember_me %}checked{% endif %}> <span>Запомнить меня</span></label>
              <label class="check-row"><input id="use_mtproxy" type="checkbox" name="use_mtproxy" {% if form.use_mtproxy %}checked{% endif %}> <span>Использовать mtproxy</span></label>
              <label class="check-row"><input id="use_sftp" type="checkbox" name="use_sftp" {% if form.use_sftp %}checked{% endif %}> <span>Загружать на SFTP</span></label>
              <label class="check-row"><input id="use_ftps" type="checkbox" name="use_ftps" {% if form.use_ftps %}checked{% endif %}> <span>Загружать на FTPS</span></label>
              <label class="check-row"><input id="enable_periodic_checks" type="checkbox" name="enable_periodic_checks" {% if form.enable_periodic_checks %}checked{% endif %}> <span>Периодически проверять новые главы</span></label>
              <label class="check-row"><input id="download_new" type="checkbox" name="download_new" {% if form.download_new %}checked{% endif %}> <span>Скачать новые</span></label>
            </div>
            <div class="full">
              <div class="index-inline">
                <div class="field-sm">
                  <div class="label-row">
                    <label>CHANNEL_ID</label>
                    <span class="help" tabindex="0" data-tip="Username канала (@mychannel) или числовой id (-100...).">?</span>
                  </div>
                  <input id="channel_id" name="channel_id" value="{{ form.channel_id }}" placeholder="@channel or -100..." required>
                </div>
                <div class="field-xs">
                  <div class="label-row">
                    <label>С индекса</label>
                    <span class="help" tabindex="0" data-tip="Начальный номер аудио из правого списка предпросмотра.">?</span>
                  </div>
                  <input id="from_index" name="from_index" value="{{ form.from_index }}" placeholder="1">
                </div>
                <div class="field-xs">
                  <div class="label-row">
                    <label>По индекс</label>
                    <span class="help" tabindex="0" data-tip="Конечный номер аудио из правого списка предпросмотра.">?</span>
                  </div>
                  <input id="to_index" name="to_index" value="{{ form.to_index }}" placeholder="50">
                </div>
              </div>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn" formaction="/authorize" type="submit">Авторизоваться</button>
            <button class="btn secondary" formaction="/check_sftp" type="submit">Проверить SFTP</button>
            <button class="btn secondary" formaction="/check_ftps" type="submit">Проверить FTPS</button>
            <button class="btn secondary" formaction="/preview" type="submit">Обновить предпросмотр</button>
            <button class="btn" formaction="/start" type="submit">Начать скачивание</button>
            <button class="btn secondary" formaction="/start_upload" type="submit">Начать загрузку</button>
            <button class="btn secondary" formaction="/stop_download" type="submit">Прервать загрузку</button>
            <button class="btn secondary" formaction="/stop_server" type="submit">Стоп сервер</button>
          </div>
        </div>

        <div id="tab-telegram" class="tab-panel">
          <div class="check-row">
            <input id="show-telegram-settings" type="checkbox">
            <label for="show-telegram-settings">Показать/скрыть чувствительные поля</label>
          </div>
          <div class="grid">
            <div>
              <div class="label-row">
                <label>API_ID</label>
                <span class="help" tabindex="0" data-tip="Числовой ID приложения Telegram API.">?</span>
                <a class="inline-link" href="https://my.telegram.org/apps" target="_blank" rel="noopener noreferrer">Получить</a>
              </div>
              <input class="tg-secret" type="password" name="api_id" value="{{ form.api_id }}" required>
            </div>
            <div>
              <div class="label-row">
                <label>API_HASH</label>
                <span class="help" tabindex="0" data-tip="Секретный hash приложения Telegram API.">?</span>
                <a class="inline-link" href="https://my.telegram.org/apps" target="_blank" rel="noopener noreferrer">Получить</a>
              </div>
              <input class="tg-secret" type="password" name="api_hash" value="{{ form.api_hash }}" required>
            </div>
            <div>
              <div class="label-row">
                <label>PHONE</label>
                <span class="help" tabindex="0" data-tip="Номер Telegram-аккаунта в международном формате, например +79990001122.">?</span>
              </div>
              <input class="tg-secret" type="password" name="phone" value="{{ form.phone }}" placeholder="+79990001122" required>
            </div>
            <div>
              <div class="label-row">
                <label>Код из Telegram (если запросили)</label>
                <span class="help" tabindex="0" data-tip="Одноразовый код подтверждения, который Telegram присылает при входе.">?</span>
              </div>
              <input class="tg-secret" type="password" name="code" value="{{ form.code }}" placeholder="12345">
            </div>
            <div>
              <div class="label-row">
                <label>Пароль 2FA (если включен)</label>
                <span class="help" tabindex="0" data-tip="Пароль облачного 2FA, если включена двухфакторная защита.">?</span>
              </div>
              <input class="tg-secret" type="password" name="password" value="{{ form.password }}" placeholder="Пароль 2FA">
            </div>
            <div id="mtproxy-group" class="full {% if not form.use_mtproxy %}hidden{% endif %}">
              <div class="label-row">
                <label>Ссылка/строка MTProxy</label>
                <span class="help" tabindex="0" data-tip="Вставьте строку целиком, например: server=example.com&port=443&secret=...">?</span>
              </div>
              <input class="tg-secret" type="password" name="mtproxy_link" value="{{ form.mtproxy_link }}" placeholder="server=example.com&port=443&secret=...">
            </div>
            <div>
              <div class="label-row">
                <label>SESSION_NAME</label>
                <span class="help" tabindex="0" data-tip="Имя файла сессии Telethon для сохранения авторизации.">?</span>
              </div>
              <input class="tg-secret" type="password" name="session_name" value="{{ form.session_name }}">
            </div>
            <div class="full">
              <div class="label-row">
                <label>Путь сохранения аудио</label>
                <span class="help" tabindex="0" data-tip="Базовая локальная папка. Внутри неё бот автоматически создаст подпапку с названием канала.">?</span>
              </div>
              <input name="download_dir" value="{{ form.download_dir }}">
            </div>
          </div>
        </div>

        <div id="tab-sftp" class="tab-panel">
          <div class="check-row">
            <input id="show-sftp-settings" type="checkbox">
            <label for="show-sftp-settings">Показать/скрыть host/login/port/password</label>
          </div>
          <div class="grid">
            <div id="sftp-group" class="full">
              <div class="grid">
                <div>
                  <div class="label-row"><label>SFTP_HOST</label></div>
                  <input class="sftp-secret" type="password" name="sftp_host" value="{{ form.sftp_host }}" placeholder="sftp.example.com">
                </div>
                <div>
                  <div class="label-row"><label>SFTP_PORT</label></div>
                  <input class="sftp-secret" type="password" name="sftp_port" value="{{ form.sftp_port }}" placeholder="22">
                </div>
                <div>
                  <div class="label-row"><label>SFTP_USERNAME</label></div>
                  <input class="sftp-secret" type="password" name="sftp_username" value="{{ form.sftp_username }}" placeholder="username">
                </div>
                <div>
                  <div class="label-row"><label>SFTP_PASSWORD</label></div>
                  <input class="sftp-secret" type="password" name="sftp_password" value="{{ form.sftp_password }}" placeholder="password">
                </div>
                <div class="full">
                  <div class="label-row">
                    <label>SFTP_REMOTE_DIR</label>
                    <span class="help" tabindex="0" data-tip="Базовый удалённый каталог. Внутри него автоматически создаётся подпапка с названием книги (канала).">?</span>
                  </div>
                  <input name="sftp_remote_dir" value="{{ form.sftp_remote_dir }}" placeholder="/uploads/books">
                </div>
                <div class="full">
                  <div class="check-row">
                    <input id="cleanup_local_after_sftp" type="checkbox" name="cleanup_local_after_sftp" {% if form.cleanup_local_after_sftp %}checked{% endif %}>
                    <label for="cleanup_local_after_sftp">Удалять локальный файл после подтверждённой загрузки на SFTP</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="tab-ftps" class="tab-panel">
          <div class="check-row">
            <input id="show-ftps-settings" type="checkbox">
            <label for="show-ftps-settings">Показать/скрыть host/login/port/password</label>
          </div>
          <div class="grid">
            <div id="ftps-group" class="full">
              <div class="grid">
                <div>
                  <div class="label-row"><label>FTPS_HOST</label></div>
                  <input class="ftps-secret" type="password" name="ftps_host" value="{{ form.ftps_host }}" placeholder="ftps.example.com">
                </div>
                <div>
                  <div class="label-row"><label>FTPS_PORT</label></div>
                  <input class="ftps-secret" type="password" name="ftps_port" value="{{ form.ftps_port }}" placeholder="21">
                </div>
                <div>
                  <div class="label-row"><label>FTPS_USERNAME</label></div>
                  <input class="ftps-secret" type="password" name="ftps_username" value="{{ form.ftps_username }}" placeholder="username">
                </div>
                <div>
                  <div class="label-row"><label>FTPS_PASSWORD</label></div>
                  <input class="ftps-secret" type="password" name="ftps_password" value="{{ form.ftps_password }}" placeholder="password">
                </div>
                <div class="full">
                  <div class="label-row">
                    <label>FTPS_REMOTE_DIR</label>
                    <span class="help" tabindex="0" data-tip="Базовый удалённый каталог. Внутри него автоматически создаётся подпапка с названием книги (канала).">?</span>
                  </div>
                  <input name="ftps_remote_dir" value="{{ form.ftps_remote_dir }}" placeholder="/uploads/books">
                </div>
                <div>
                  <div class="label-row">
                    <label>Безопасный режим FTPS</label>
                    <span class="help" tabindex="0" data-tip="Явный (explicit) - стандартный FTPS на 21 порту. Неявный (implicit) - TLS сразу при подключении, чаще на 990 порту.">?</span>
                  </div>
                  <select name="ftps_security_mode">
                    <option value="explicit" {% if form.ftps_security_mode != 'implicit' %}selected{% endif %}>Явный (explicit)</option>
                    <option value="implicit" {% if form.ftps_security_mode == 'implicit' %}selected{% endif %}>Неявный (implicit)</option>
                  </select>
                </div>
                <div>
                  <div class="check-row">
                    <input id="ftps_passive_mode" type="checkbox" name="ftps_passive_mode" {% if form.ftps_passive_mode %}checked{% endif %}>
                    <label for="ftps_passive_mode">Режим передачи: пассивный</label>
                  </div>
                </div>
                <div class="field-sm">
                  <div class="label-row">
                    <label>Потоков upload</label>
                    <span class="help" tabindex="0" data-tip="Сколько файлов одновременно выгружать на удаленный сервер в режиме кнопки 'Начать загрузку'.">?</span>
                  </div>
                  <input name="ftps_upload_concurrency" value="{{ form.ftps_upload_concurrency }}" placeholder="2">
                </div>
                <div class="full">
                  <div class="check-row">
                    <input id="ftps_verify_tls" type="checkbox" name="ftps_verify_tls" {% if form.ftps_verify_tls %}checked{% endif %}>
                    <label for="ftps_verify_tls">Проверять TLS-сертификат FTPS сервера</label>
                  </div>
                </div>
                <div class="full">
                  <div class="check-row">
                    <input id="cleanup_local_after_ftps" type="checkbox" name="cleanup_local_after_ftps" {% if form.cleanup_local_after_ftps %}checked{% endif %}>
                    <label for="cleanup_local_after_ftps">Удалять локальный файл после подтверждённой загрузки на FTPS</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </form>

      <div class="status">
        <div>
          Статус: 
          <span id="run-state" class="{% if status.running %}run{% else %}stop{% endif %}">
            {% if status.running %}Запущен{% else %}Остановлен{% endif %}
          </span>
        </div>
        <div id="status-message">Сообщение: {{ status.message }}</div>
        <div id="status-auth">
          Авторизация:
          {% if auth_status.authorized %}
            <span class="run">успешно</span>
          {% else %}
            <span class="stop">не выполнена</span>
          {% endif %}
          ({{ auth_status.message }})
        </div>
        <div id="status-proxy">
          MTProxy:
          {% if proxy_status.enabled %}
            {% if proxy_status.available %}
              <span class="run">подключение установлено</span>
            {% else %}
              <span class="stop">ошибка подключения</span>
            {% endif %}
          {% else %}
            <span class="stop">не используется</span>
          {% endif %}
        </div>
        <div id="status-sftp">
          SFTP:
          {% if sftp_status.enabled %}
            {% if sftp_status.available %}
              <span class="run">подключение установлено</span>
            {% else %}
              <span class="stop">ошибка подключения</span>
            {% endif %}
          {% else %}
            <span class="stop">не используется</span>
          {% endif %}
        </div>
        <div id="status-ftps">
          FTPS:
          {% if ftps_status.enabled %}
            {% if ftps_status.available %}
              <span class="run">подключение установлено</span>
            {% else %}
              <span class="stop">ошибка подключения</span>
            {% endif %}
          {% else %}
            <span class="stop">не используется</span>
          {% endif %}
        </div>
        <div id="status-counters">
          Скачано: {{ status.downloaded }} | Ошибок: {{ status.failed }} | Пропущено: {{ status.skipped }}
        </div>
        <div id="status-sftp-counters">
          Upload: загружено {{ status.sftp_uploaded }} | пропущено {{ status.sftp_skipped }} | ошибок {{ status.sftp_failed }}
        </div>
        <div id="status-concurrency">
          Параллельность: {{ status.current_concurrency }} / {{ status.configured_concurrency }}
        </div>
        <div id="status-progress">Прогресс файла: {{ status.progress_percent }}% ({{ status.progress_received }} / {{ status.progress_total }} байт)</div>
        <div id="status-upload-progress">Upload: {{ status.upload_progress_percent }}% ({{ status.upload_progress_received }} / {{ status.upload_progress_total }} байт) | 0 B/s | ETA: —</div>
        <div id="file-progress-list" class="table-wrap" style="max-height:none; margin-top:8px;">
          <table>
            <thead>
              <tr>
                <th>message_id</th>
                <th>Прогресс</th>
                <th>Статус</th>
              </tr>
            </thead>
            <tbody id="file-progress-body">
              <tr><td colspan="3">Нет активных загрузок.</td></tr>
            </tbody>
          </table>
        </div>
        <div id="upload-progress-list" class="table-wrap" style="max-height:none; margin-top:8px;">
          <table>
            <thead>
              <tr>
                <th>upload</th>
                <th>Прогресс</th>
                <th>Статус</th>
              </tr>
            </thead>
            <tbody id="upload-progress-body">
              <tr><td colspan="3">Нет активных upload задач.</td></tr>
            </tbody>
          </table>
        </div>
        <div id="status-current">Текущий message_id: {{ status.current_message_id }}</div>
        <div id="status-file">Последний файл: {{ status.last_file }}</div>
        <div id="status-updated">Обновлено: {{ status.updated_at }}</div>

        {% if message %}
        <div>Результат: {{ message }}</div>
        {% endif %}
        {% if need_code %}
        <div>Требуется код подтверждения. Введите поле "Код из Telegram" и нажмите "Авторизоваться" снова.</div>
        {% endif %}
        {% if need_password %}
        <div>Требуется пароль 2FA. Введите поле "Пароль 2FA" и нажмите "Авторизоваться" снова.</div>
        {% endif %}
      </div>

      <p class="note">Статус скачивания обновляется через серверный поток (SSE) без постоянного polling.</p>
      <div id="debug-box" class="debug-box">
        <pre id="debug-log" class="debug-log">Debug disabled.</pre>
      </div>
    </div>

    <div class="card">
      <h2>Предпросмотр аудио</h2>
      <p class="sub">Нумерация используется для выбора диапазона "с / по".</p>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>message_id</th>
              <th>✓</th>
              <th>Название</th>
              <th>Дата</th>
            </tr>
          </thead>
          <tbody>
            {% if preview %}
              {% for item in preview %}
              <tr>
                <td class="mono">{{ item.index }}</td>
                <td class="mono">{{ item.message_id }}</td>
                <td>{% if item.downloaded %}<span class="downloaded-ok">✓</span>{% else %}<span class="downloaded-empty">-</span>{% endif %}</td>
                <td>{{ item.title }}</td>
                <td>{{ item.date }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5">Нет данных. Нажмите "Авторизоваться" или "Обновить предпросмотр".</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    function applyStatusPayload(s) {
      const runState = document.getElementById('run-state');
      runState.textContent = s.running ? 'Запущен' : 'Остановлен';
      runState.className = s.running ? 'run' : 'stop';

      document.getElementById('status-message').textContent = `Сообщение: ${s.message || ''}`;
      const authText = s.auth_authorized ? 'успешно' : 'не выполнена';
      const authClass = s.auth_authorized ? 'run' : 'stop';
      document.getElementById('status-auth').innerHTML = `Авторизация: <span class="${authClass}">${authText}</span> (${s.auth_message || ''})`;
      let proxyText = 'не используется';
      let proxyClass = 'stop';
      if (s.proxy_enabled) {
        proxyText = s.proxy_available ? 'подключение установлено' : 'ошибка подключения';
        proxyClass = s.proxy_available ? 'run' : 'stop';
      }
      document.getElementById('status-proxy').innerHTML = `MTProxy: <span class="${proxyClass}">${proxyText}</span>`;
      let sftpText = 'не используется';
      let sftpClass = 'stop';
      if (s.sftp_enabled) {
        sftpText = s.sftp_available ? 'подключение установлено' : 'ошибка подключения';
        sftpClass = s.sftp_available ? 'run' : 'stop';
      }
      document.getElementById('status-sftp').innerHTML = `SFTP: <span class="${sftpClass}">${sftpText}</span>`;
      let ftpsText = 'не используется';
      let ftpsClass = 'stop';
      if (s.ftps_enabled) {
        ftpsText = s.ftps_available ? 'подключение установлено' : 'ошибка подключения';
        ftpsClass = s.ftps_available ? 'run' : 'stop';
      }
      document.getElementById('status-ftps').innerHTML = `FTPS: <span class="${ftpsClass}">${ftpsText}</span>`;
      document.getElementById('status-counters').textContent = `Скачано: ${s.downloaded || 0} | Ошибок: ${s.failed || 0} | Пропущено: ${s.skipped || 0}`;
      document.getElementById('status-sftp-counters').textContent = `Upload: загружено ${s.sftp_uploaded || 0} | пропущено ${s.sftp_skipped || 0} | ошибок ${s.sftp_failed || 0}`;
      document.getElementById('status-concurrency').textContent = `Параллельность: ${s.current_concurrency || 1} / ${s.configured_concurrency || 1}`;
      document.getElementById('status-progress').textContent = `Прогресс файла: ${s.progress_percent || 0}% (${s.progress_received || 0} / ${s.progress_total || 0} байт)`;
      document.getElementById('status-upload-progress').textContent = `Upload: ${s.upload_progress_percent || 0}% (${s.upload_progress_received || 0} / ${s.upload_progress_total || 0} байт) | ${formatSpeed(s.upload_progress_speed_bps || 0)} | ETA: ${formatEta(s.upload_progress_eta_sec || 0)}`;
      document.getElementById('status-current').textContent = `Текущий message_id: ${s.current_message_id || ''}`;
      document.getElementById('status-file').textContent = `Последний файл: ${s.last_file || ''}`;
      document.getElementById('status-updated').textContent = `Обновлено: ${s.updated_at || ''}`;
      renderFileProgresses(s.file_progresses || {});
      renderUploadProgresses(s.upload_file_progresses || {});
    }

    function renderFileProgresses(itemsMap) {
      const body = document.getElementById('file-progress-body');
      const entries = Object.entries(itemsMap || {});
      if (!entries.length) {
        body.innerHTML = '<tr><td colspan="3">Нет активных загрузок.</td></tr>';
        return;
      }
      entries.sort((a, b) => String(b[0]).localeCompare(String(a[0])));
      const viewEntries = entries.slice(0, 3);
      body.innerHTML = '';
      viewEntries.forEach(([messageId, item]) => {
        const percent = Number(item.percent || 0);
        const received = Number(item.received || 0);
        const total = Number(item.total || 0);
        const state = String(item.state || '');
        const speedText = formatSpeed(item.speed_bps || 0);
        const etaText = formatEta(item.eta_sec || 0);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="mono">${messageId}</td>
          <td class="progress-cell">
            <progress max="100" value="${percent}"></progress>
            <div class="progress-meta">${percent}% (${received}/${total})</div>
            <div class="progress-meta">${speedText} | ETA: ${etaText}</div>
          </td>
          <td>${state}</td>
        `;
        body.appendChild(row);
      });
      if (entries.length > viewEntries.length) {
        const extra = entries.length - viewEntries.length;
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="3">Ещё ${extra} файла(ов) в очереди...</td>`;
        body.appendChild(row);
      }
    }

    function renderUploadProgresses(itemsMap) {
      const body = document.getElementById('upload-progress-body');
      const entries = Object.entries(itemsMap || {});
      if (!entries.length) {
        body.innerHTML = '<tr><td colspan="3">Нет активных upload задач.</td></tr>';
        return;
      }
      entries.sort((a, b) => String(b[0]).localeCompare(String(a[0])));
      const viewEntries = entries.slice(0, 3);
      body.innerHTML = '';
      viewEntries.forEach(([uploadId, item]) => {
        const percent = Number(item.percent || 0);
        const received = Number(item.received || 0);
        const total = Number(item.total || 0);
        const state = String(item.state || '');
        const speedText = formatSpeed(item.speed_bps || 0);
        const etaText = formatEta(item.eta_sec || 0);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="mono">${uploadId}</td>
          <td class="progress-cell">
            <progress max="100" value="${percent}"></progress>
            <div class="progress-meta">${percent}% (${received}/${total})</div>
            <div class="progress-meta">${speedText} | ETA: ${etaText}</div>
          </td>
          <td>${state}</td>
        `;
        body.appendChild(row);
      });
      if (entries.length > viewEntries.length) {
        const extra = entries.length - viewEntries.length;
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="3">Ещё ${extra} upload задач(и)...</td>`;
        body.appendChild(row);
      }
    }

    function formatSpeed(speedBps) {
      const v = Number(speedBps || 0);
      if (!Number.isFinite(v) || v <= 0) return '0 B/s';
      if (v < 1024) return `${v.toFixed(0)} B/s`;
      if (v < 1024 * 1024) return `${(v / 1024).toFixed(1)} KB/s`;
      return `${(v / (1024 * 1024)).toFixed(2)} MB/s`;
    }

    function formatEta(seconds) {
      const s = Number(seconds || 0);
      if (!Number.isFinite(s) || s <= 0) return '—';
      const total = Math.round(s);
      const m = Math.floor(total / 60);
      const sec = total % 60;
      if (m <= 0) return `${sec}s`;
      return `${m}m ${sec}s`;
    }

    function connectStatusStream() {
      if (!window.EventSource) {
        return;
      }
      const es = new EventSource('/status_stream');
      es.onmessage = (event) => {
        try {
          const payload = JSON.parse(event.data || '{}');
          applyStatusPayload(payload);
        } catch (_) {
        }
      };
      es.onerror = () => {
        // browser auto-reconnects SSE connection
      };
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      const button = document.getElementById('theme-toggle');
      button.textContent = theme === 'dark' ? 'Светлая тема' : 'Тёмная тема';
    }

    document.getElementById('theme-toggle').addEventListener('click', () => {
      const current = localStorage.getItem('theme') || 'light';
      const next = current === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      applyTheme(next);
    });

    applyTheme(localStorage.getItem('theme') || 'light');

    function activateTab(tabId) {
      document.querySelectorAll('.tab-panel').forEach((el) => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach((el) => el.classList.remove('active'));
      const panel = document.getElementById(tabId);
      const btn = document.querySelector(`.tab-btn[data-tab-target="${tabId}"]`);
      if (panel) panel.classList.add('active');
      if (btn) btn.classList.add('active');
    }

    document.querySelectorAll('.tab-btn').forEach((btn) => {
      btn.addEventListener('click', () => activateTab(btn.getAttribute('data-tab-target')));
    });
    activateTab('tab-control');

    function bindRevealToggle(toggleId, selector) {
      const toggle = document.getElementById(toggleId);
      const apply = () => {
        document.querySelectorAll(selector).forEach((input) => {
          input.type = toggle.checked ? 'text' : 'password';
        });
      };
      toggle.addEventListener('change', apply);
      apply();
    }

    bindRevealToggle('show-telegram-settings', '.tg-secret');
    bindRevealToggle('show-sftp-settings', '.sftp-secret');
    bindRevealToggle('show-ftps-settings', '.ftps-secret');

    function toggleMtproxyField() {
      const useProxy = document.getElementById('use_mtproxy').checked;
      const group = document.getElementById('mtproxy-group');
      if (useProxy) {
        group.classList.remove('hidden');
      } else {
        group.classList.add('hidden');
      }
    }

    document.getElementById('use_mtproxy').addEventListener('change', toggleMtproxyField);
    toggleMtproxyField();

    // Allow only one remote upload protocol at a time.
    document.getElementById('use_sftp').addEventListener('change', (e) => {
      if (e.target.checked) {
        document.getElementById('use_ftps').checked = false;
      }
    });
    document.getElementById('use_ftps').addEventListener('change', (e) => {
      if (e.target.checked) {
        document.getElementById('use_sftp').checked = false;
      }
    });
    if (document.getElementById('use_sftp').checked && document.getElementById('use_ftps').checked) {
      document.getElementById('use_ftps').checked = false;
    }

    async function loadChannelMenu() {
      const form = document.querySelector('form');
      const data = new FormData(form);
      const status = document.getElementById('channel-menu-status');
      const list = document.getElementById('channel-menu-list');
      status.textContent = 'Проверка каналов...';
      list.innerHTML = '';
      try {
        const response = await fetch('/channels_status', { method: 'POST', body: data });
        const payload = await response.json();
        status.textContent = payload.message || '';
        if (!payload.items || payload.items.length === 0) {
          list.innerHTML = '<div class="sub">Нет сохранённых каналов.</div>';
          return;
        }
        payload.items.forEach((item) => {
          const row = document.createElement('div');
          row.className = 'channel-item';
          const left = document.createElement('div');
          left.className = 'channel-meta';
          left.innerHTML = `<div><strong>${item.channel_title || item.channel_ref}</strong></div><div class="mono">${item.channel_ref}</div><div class="sub">${item.status || ''}</div><div class="sub">Последняя проверка: ${item.last_checked_at || 'никогда'}</div>`;
          const rightWrap = document.createElement('div');
          rightWrap.className = 'channel-actions';
          const badge = document.createElement('span');
          badge.className = `badge ${item.has_new_audio ? 'ok' : 'warn'}`;
          badge.textContent = item.has_new_audio ? 'Новые есть' : 'Новых нет';
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn secondary xs';
          btn.textContent = 'Выбрать';
          btn.addEventListener('click', () => {
            document.getElementById('channel_id').value = item.channel_ref || '';
            document.getElementById('cleanup_local_after_sftp').checked = !!item.cleanup_local;
            document.getElementById('cleanup_local_after_ftps').checked = !!item.cleanup_local;
            document.getElementById('status-file').textContent = `Последний файл: ${item.last_file_path || ''}`;
            document.getElementById('status-current').textContent = `Текущий message_id: ${item.last_message_id || ''}`;
          });
          const prefWrap = document.createElement('div');
          prefWrap.className = 'channel-prefs';
          prefWrap.innerHTML = `
            <label class="check-row"><input type="checkbox" data-pref="check_new">Проверять новые главы</label>
            <label class="check-row"><input type="checkbox" data-pref="auto_download">Включить автозагрузку</label>
            <label class="check-row"><input type="checkbox" data-pref="auto_sftp">Включить автозагрузку на SFTP</label>
            <label class="check-row"><input type="checkbox" data-pref="auto_ftps">Включить автозагрузку на FTPS</label>
            <label class="check-row"><input type="checkbox" data-pref="cleanup_local">Очистка локального после выгрузки</label>
          `;
          prefWrap.querySelector('input[data-pref="check_new"]').checked = !!item.check_new;
          prefWrap.querySelector('input[data-pref="auto_download"]').checked = !!item.auto_download;
          prefWrap.querySelector('input[data-pref="auto_sftp"]').checked = !!item.auto_sftp;
          prefWrap.querySelector('input[data-pref="auto_ftps"]').checked = !!item.auto_ftps;
          prefWrap.querySelector('input[data-pref="cleanup_local"]').checked = !!item.cleanup_local;

          const saveBtn = document.createElement('button');
          saveBtn.type = 'button';
          saveBtn.className = 'btn secondary xs';
          saveBtn.textContent = 'Сохранить';
          saveBtn.addEventListener('click', async () => {
            const data = new FormData(document.querySelector('form'));
            data.set('channel_ref', item.channel_ref || '');
            data.set('channel_id', String(item.channel_id || 0));
            data.set('channel_title', item.channel_title || '');
            data.set('check_new', prefWrap.querySelector('input[data-pref="check_new"]').checked ? '1' : '0');
            data.set('auto_download', prefWrap.querySelector('input[data-pref="auto_download"]').checked ? '1' : '0');
            data.set('auto_sftp', prefWrap.querySelector('input[data-pref="auto_sftp"]').checked ? '1' : '0');
            data.set('auto_ftps', prefWrap.querySelector('input[data-pref="auto_ftps"]').checked ? '1' : '0');
            data.set('cleanup_local', prefWrap.querySelector('input[data-pref="cleanup_local"]').checked ? '1' : '0');
            const response = await fetch('/channels_preferences_update', { method: 'POST', body: data });
            const result = await response.json();
            status.textContent = result.message || '';
          });
          rightWrap.appendChild(badge);
          rightWrap.appendChild(document.createElement('br'));
          rightWrap.appendChild(btn);
          rightWrap.appendChild(document.createElement('br'));
          rightWrap.appendChild(saveBtn);
          row.appendChild(left);
          row.appendChild(prefWrap);
          row.appendChild(rightWrap);
          list.appendChild(row);
        });
      } catch (e) {
        status.textContent = `Ошибка загрузки списка: ${e}`;
      }
    }

    document.getElementById('channel-menu-toggle').addEventListener('click', async () => {
      const box = document.getElementById('channel-menu-box');
      box.classList.toggle('hidden');
      if (!box.classList.contains('hidden')) {
        await loadChannelMenu();
      }
    });

    async function refreshDebugLogs() {
      const toggle = document.getElementById('debug-toggle');
      const box = document.getElementById('debug-box');
      const pre = document.getElementById('debug-log');
      if (!toggle.checked) {
        box.classList.remove('show');
        return;
      }
      box.classList.add('show');
      try {
        const response = await fetch('/debug_logs', { cache: 'no-store' });
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        pre.textContent = (data.lines || []).join('\n') || 'No logs yet.';
        box.scrollTop = box.scrollHeight;
      } catch (_) {
      }
    }

    document.getElementById('debug-toggle').addEventListener('change', refreshDebugLogs);

    async function applyDownloadNewRange(enabled) {
      const fromInput = document.getElementById('from_index');
      const toInput = document.getElementById('to_index');
      fromInput.disabled = enabled;
      toInput.disabled = enabled;
      if (!enabled) {
        return;
      }
      const data = new FormData(document.querySelector('form'));
      try {
        const response = await fetch('/suggest_new_range', { method: 'POST', body: data });
        const payload = await response.json();
        if (payload && payload.ok) {
          fromInput.value = payload.from_index || '';
          toInput.value = payload.to_index || '';
          const status = document.getElementById('channel-menu-status');
          if (status && payload.message) {
            status.textContent = payload.message;
          }
        }
      } catch (_) {
      }
    }

    document.getElementById('download_new').addEventListener('change', (e) => {
      applyDownloadNewRange(!!e.target.checked);
    });
    applyDownloadNewRange(document.getElementById('download_new').checked);

    setInterval(() => {
      refreshDebugLogs();
    }, 2000);
    connectStatusStream();
    refreshDebugLogs();
  </script>
</body>
</html>
