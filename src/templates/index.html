<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TeleGaParser UI</title>
  <style>
    :root {
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #1f2933;
      --muted: #6b7c93;
      --line: #d9e2ec;
      --primary: #0b6efd;
      --ok: #0f9d58;
      --warn: #d97706;
      --row: #f7fafc;
      --status-bg: #f8fbff;
      --input-bg: #ffffff;
      --btn-secondary: #4a5a70;
    }
    [data-theme="dark"] {
      --bg: #0f1720;
      --card: #17212b;
      --text: #e5edf6;
      --muted: #9fb0c4;
      --line: #324355;
      --primary: #3b82f6;
      --ok: #22c55e;
      --warn: #f59e0b;
      --row: #1e2b38;
      --status-bg: #1b2734;
      --input-bg: #1e2b38;
      --btn-secondary: #2f3e4e;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg) 100%);
      color: var(--text);
    }
    .wrap {
      max-width: 1260px;
      margin: 24px auto;
      padding: 0 16px;
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 14px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 6px 20px rgba(16, 24, 40, 0.06);
    }
    h1 {
      margin: 0 0 6px;
      font-size: 24px;
    }
    h2 {
      margin: 0 0 10px;
      font-size: 18px;
    }
    .sub {
      margin: 0 0 16px;
      color: var(--muted);
      font-size: 14px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .full {
      grid-column: 1 / -1;
    }
    label {
      font-size: 13px;
      color: var(--muted);
      display: block;
      margin-bottom: 5px;
    }
    .label-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 5px;
      flex-wrap: wrap;
    }
    .label-row label {
      margin-bottom: 0;
    }
    .inline-link {
      font-size: 12px;
      color: var(--primary);
      text-decoration: none;
    }
    .inline-link:hover {
      text-decoration: underline;
    }
    .help {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid var(--line);
      color: var(--muted);
      font-size: 11px;
      cursor: help;
      user-select: none;
    }
    .help::after {
      content: attr(data-tip);
      position: absolute;
      left: 50%;
      bottom: calc(100% + 8px);
      transform: translateX(-50%);
      min-width: 180px;
      max-width: 260px;
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px 9px;
      font-size: 12px;
      line-height: 1.3;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      display: none;
      z-index: 10;
      pointer-events: none;
    }
    .help:hover::after,
    .help:focus::after {
      display: block;
    }
    input {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 10px 12px;
      box-sizing: border-box;
      font-size: 14px;
      color: var(--text);
      background: var(--input-bg);
    }
    .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .check-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      margin-bottom: 6px;
    }
    .check-row input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    .hidden {
      display: none;
    }
    .btn {
      border: 0;
      border-radius: 8px;
      padding: 11px 14px;
      font-size: 14px;
      cursor: pointer;
      background: var(--primary);
      color: #fff;
    }
    .btn.secondary {
      background: var(--btn-secondary);
    }
    .status {
      margin-top: 14px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: var(--status-bg);
      font-size: 14px;
    }
    .run {
      color: var(--ok);
      font-weight: 600;
    }
    .stop {
      color: var(--warn);
      font-weight: 600;
    }
    .table-wrap {
      max-height: 70vh;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid var(--line);
      text-align: left;
      vertical-align: top;
    }
    th {
      position: sticky;
      top: 0;
      background: var(--row);
      z-index: 1;
    }
    .mono {
      font-family: Consolas, monospace;
    }
    .note {
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
    }
    @media (max-width: 980px) {
      .wrap {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 720px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>TeleGaParser</h1>
      <p class="sub">Авторизация Telegram, выбор канала и запуск скачивания аудио.</p>
      <button id="theme-toggle" class="btn secondary" type="button">Тёмная тема</button>

      <form method="post" action="/authorize">
        <div class="grid">
          <div>
            <div class="label-row">
              <label>API_ID</label>
              <span class="help" tabindex="0" data-tip="Числовой ID приложения Telegram API.">?</span>
              <a class="inline-link" href="https://my.telegram.org/apps" target="_blank" rel="noopener noreferrer">Получить</a>
            </div>
            <input name="api_id" value="{{ form.api_id }}" required>
          </div>
          <div>
            <div class="label-row">
              <label>API_HASH</label>
              <span class="help" tabindex="0" data-tip="Секретный hash приложения Telegram API.">?</span>
              <a class="inline-link" href="https://my.telegram.org/apps" target="_blank" rel="noopener noreferrer">Получить</a>
            </div>
            <input name="api_hash" value="{{ form.api_hash }}" required>
          </div>
          <div>
            <div class="label-row">
              <label>PHONE</label>
              <span class="help" tabindex="0" data-tip="Номер Telegram-аккаунта в международном формате, например +79990001122.">?</span>
            </div>
            <input name="phone" value="{{ form.phone }}" placeholder="+79990001122" required>
          </div>
          <div>
            <div class="label-row">
              <label>CHANNEL_ID</label>
              <span class="help" tabindex="0" data-tip="Username канала (@mychannel) или числовой id (-100...).">?</span>
            </div>
            <input name="channel_id" value="{{ form.channel_id }}" placeholder="@channel or -100..." required>
          </div>
          <div class="full">
            <div class="check-row">
              <input id="use_mtproxy" type="checkbox" name="use_mtproxy" {% if form.use_mtproxy %}checked{% endif %}>
              <label for="use_mtproxy">Использовать mtproxy</label>
              <span class="help" tabindex="0" data-tip="Если включено, подключение к Telegram пойдет через MTProxy.">?</span>
            </div>
          </div>
          <div class="full">
            <div class="check-row">
              <input id="remember_me" type="checkbox" name="remember_me" {% if form.remember_me %}checked{% endif %}>
              <label for="remember_me">Запомнить меня</label>
              <span class="help" tabindex="0" data-tip="Сохраняет Telegram-сессию, чтобы не проходить авторизацию заново.">?</span>
            </div>
          </div>
          <div id="mtproxy-group" class="full {% if not form.use_mtproxy %}hidden{% endif %}">
            <div class="label-row">
              <label>Ссылка/строка MTProxy</label>
              <span class="help" tabindex="0" data-tip="Вставьте строку целиком, например: server=example.com&port=443&secret=...">?</span>
            </div>
            <input name="mtproxy_link" value="{{ form.mtproxy_link }}" placeholder="server=example.com&port=443&secret=...">
          </div>
          <div class="full">
            <div class="label-row">
              <label>Путь сохранения аудио</label>
              <span class="help" tabindex="0" data-tip="Базовая локальная папка. Внутри неё бот автоматически создаст подпапку с названием канала.">?</span>
            </div>
            <input name="download_dir" value="{{ form.download_dir }}">
          </div>
          <div>
            <div class="label-row">
              <label>SESSION_NAME</label>
              <span class="help" tabindex="0" data-tip="Имя файла сессии Telethon для сохранения авторизации.">?</span>
            </div>
            <input name="session_name" value="{{ form.session_name }}">
          </div>
          <div>
            <div class="label-row">
              <label>STARTUP_SCAN_LIMIT</label>
              <span class="help" tabindex="0" data-tip="Сколько последних сообщений проверить при старте.">?</span>
            </div>
            <input name="startup_scan_limit" value="{{ form.startup_scan_limit }}">
          </div>
          <div>
            <div class="label-row">
              <label>Потоков загрузки</label>
              <span class="help" tabindex="0" data-tip="Сколько аудиофайлов скачивать одновременно. Рекомендуется 2-4.">?</span>
            </div>
            <input name="download_concurrency" value="{{ form.download_concurrency }}" placeholder="3">
          </div>
          <div>
            <div class="label-row">
              <label>Код из Telegram (если запросили)</label>
              <span class="help" tabindex="0" data-tip="Одноразовый код подтверждения, который Telegram присылает при входе.">?</span>
            </div>
            <input name="code" value="{{ form.code }}" placeholder="12345">
          </div>
          <div>
            <div class="label-row">
              <label>Пароль 2FA (если включен)</label>
              <span class="help" tabindex="0" data-tip="Пароль облачного 2FA, если включена двухфакторная защита.">?</span>
            </div>
            <input type="password" name="password" value="{{ form.password }}" placeholder="Пароль 2FA">
          </div>
          <div>
            <div class="label-row">
              <label>С индекса</label>
              <span class="help" tabindex="0" data-tip="Начальный номер аудио из правого списка предпросмотра.">?</span>
            </div>
            <input name="from_index" value="{{ form.from_index }}" placeholder="1">
          </div>
          <div>
            <div class="label-row">
              <label>По индекс</label>
              <span class="help" tabindex="0" data-tip="Конечный номер аудио из правого списка предпросмотра.">?</span>
            </div>
            <input name="to_index" value="{{ form.to_index }}" placeholder="50">
          </div>
        </div>

        <div class="btn-row">
          <button class="btn" formaction="/authorize" type="submit">Авторизоваться</button>
          <button class="btn secondary" formaction="/preview" type="submit">Обновить предпросмотр</button>
          <button class="btn" formaction="/start" type="submit">Начать скачивание</button>
          <button class="btn secondary" formaction="/stop_server" type="submit">Стоп сервер</button>
        </div>
      </form>

      <div class="status">
        <div>
          Статус: 
          <span id="run-state" class="{% if status.running %}run{% else %}stop{% endif %}">
            {% if status.running %}Запущен{% else %}Остановлен{% endif %}
          </span>
        </div>
        <div id="status-message">Сообщение: {{ status.message }}</div>
        <div id="status-auth">
          Авторизация:
          {% if auth_status.authorized %}
            <span class="run">успешно</span>
          {% else %}
            <span class="stop">не выполнена</span>
          {% endif %}
          ({{ auth_status.message }})
        </div>
        <div id="status-proxy">
          MTProxy:
          {% if proxy_status.enabled %}
            {% if proxy_status.available %}
              <span class="run">подключение установлено</span>
            {% else %}
              <span class="stop">ошибка подключения</span>
            {% endif %}
          {% else %}
            <span class="stop">не используется</span>
          {% endif %}
          ({{ proxy_status.message }})
        </div>
        <div id="status-counters">
          Скачано: {{ status.downloaded }} | Ошибок: {{ status.failed }} | Пропущено: {{ status.skipped }}
        </div>
        <div id="status-concurrency">
          Параллельность: {{ status.current_concurrency }} / {{ status.configured_concurrency }}
        </div>
        <div id="status-current">Текущий message_id: {{ status.current_message_id }}</div>
        <div id="status-file">Последний файл: {{ status.last_file }}</div>
        <div id="status-updated">Обновлено: {{ status.updated_at }}</div>

        {% if message %}
        <div>Результат: {{ message }}</div>
        {% endif %}
        {% if need_code %}
        <div>Требуется код подтверждения. Введите поле "Код из Telegram" и нажмите "Авторизоваться" снова.</div>
        {% endif %}
        {% if need_password %}
        <div>Требуется пароль 2FA. Введите поле "Пароль 2FA" и нажмите "Авторизоваться" снова.</div>
        {% endif %}
      </div>

      <p class="note">Статус скачивания обновляется автоматически каждые 2 секунды.</p>
    </div>

    <div class="card">
      <h2>Предпросмотр аудио</h2>
      <p class="sub">Нумерация используется для выбора диапазона "с / по".</p>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>message_id</th>
              <th>Название</th>
              <th>Дата</th>
            </tr>
          </thead>
          <tbody>
            {% if preview %}
              {% for item in preview %}
              <tr>
                <td class="mono">{{ item.index }}</td>
                <td class="mono">{{ item.message_id }}</td>
                <td>{{ item.title }}</td>
                <td>{{ item.date }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="4">Нет данных. Нажмите "Авторизоваться" или "Обновить предпросмотр".</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    async function refreshStatus() {
      try {
        const response = await fetch('/status', { cache: 'no-store' });
        if (!response.ok) {
          return;
        }
        const s = await response.json();

        const runState = document.getElementById('run-state');
        runState.textContent = s.running ? 'Запущен' : 'Остановлен';
        runState.className = s.running ? 'run' : 'stop';

        document.getElementById('status-message').textContent = `Сообщение: ${s.message || ''}`;
        const authText = s.auth_authorized ? 'успешно' : 'не выполнена';
        const authClass = s.auth_authorized ? 'run' : 'stop';
        document.getElementById('status-auth').innerHTML = `Авторизация: <span class="${authClass}">${authText}</span> (${s.auth_message || ''})`;
        let proxyText = 'не используется';
        let proxyClass = 'stop';
        if (s.proxy_enabled) {
          proxyText = s.proxy_available ? 'подключение установлено' : 'ошибка подключения';
          proxyClass = s.proxy_available ? 'run' : 'stop';
        }
        document.getElementById('status-proxy').innerHTML = `MTProxy: <span class="${proxyClass}">${proxyText}</span> (${s.proxy_message || ''})`;
        document.getElementById('status-counters').textContent = `Скачано: ${s.downloaded || 0} | Ошибок: ${s.failed || 0} | Пропущено: ${s.skipped || 0}`;
        document.getElementById('status-concurrency').textContent = `Параллельность: ${s.current_concurrency || 1} / ${s.configured_concurrency || 1}`;
        document.getElementById('status-current').textContent = `Текущий message_id: ${s.current_message_id || ''}`;
        document.getElementById('status-file').textContent = `Последний файл: ${s.last_file || ''}`;
        document.getElementById('status-updated').textContent = `Обновлено: ${s.updated_at || ''}`;
      } catch (_) {
      }
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      const button = document.getElementById('theme-toggle');
      button.textContent = theme === 'dark' ? 'Светлая тема' : 'Тёмная тема';
    }

    document.getElementById('theme-toggle').addEventListener('click', () => {
      const current = localStorage.getItem('theme') || 'light';
      const next = current === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      applyTheme(next);
    });

    applyTheme(localStorage.getItem('theme') || 'light');

    function toggleMtproxyField() {
      const useProxy = document.getElementById('use_mtproxy').checked;
      const group = document.getElementById('mtproxy-group');
      if (useProxy) {
        group.classList.remove('hidden');
      } else {
        group.classList.add('hidden');
      }
    }

    document.getElementById('use_mtproxy').addEventListener('change', toggleMtproxyField);
    toggleMtproxyField();

    setInterval(refreshStatus, 2000);
    refreshStatus();
  </script>
</body>
</html>
